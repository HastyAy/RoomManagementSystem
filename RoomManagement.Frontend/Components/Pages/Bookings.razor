@page "/bookings"
@using RoomManagement.Frontend.Services
@using RoomManager.Shared.DTOs
@using Radzen
@using Radzen.Blazor
@inject BookingService BookingService
@inject RoomService RoomService
@inject ProfessorService ProfessorService
@inject StudentService StudentService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IJSRuntime JSRuntime

<PageTitle>Booking Management</PageTitle>

<div class="bookings-container">
    <!-- Header Section -->
    <div class="header-section">
        <RadzenCard>
            <div class="header-content">
                <div class="header-info">
                    <RadzenText TextStyle="TextStyle.H3" Text="Booking Management" Style="margin: 0; font-weight: 900;" />
                    <RadzenText TextStyle="TextStyle.Body1" Text="Schedule and manage room reservations"
                                Style="color: #6b7280; margin: 0.5rem 0 0 0;" />
                </div>
                <RadzenButton Click="@OpenCreateModal" Icon="add" Text="New Booking"
                              ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Medium" />
            </div>
        </RadzenCard>
    </div>

    <!-- Search and Filter Bar -->
    <div class="controls-section" style="margin-bottom: 2rem;">
        <RadzenCard Style="padding: 1rem;">
            <RadzenRow Gap="1rem" AlignItems="AlignItems.Center">
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenLabel Text="Search Bookings" Style="font-weight: 600; margin-bottom: 0.5rem;" />
                    <RadzenTextBox @bind-Value="@searchTerm" @bind-Value:after="FilterBookings"
                                   Placeholder="Search by room, user, or purpose..."
                                   Style="width: 100%;" />
                </RadzenColumn>
                <RadzenColumn Size="6" SizeMD="3">
                    <RadzenLabel Text="Status" Style="font-weight: 600; margin-bottom: 0.5rem;" />
                    <RadzenDropDown @bind-Value="@selectedStatusFilter" @bind-Value:after="FilterBookings"
                                    Data="@statusOptions" TextProperty="Text" ValueProperty="Value"
                                    Placeholder="All Status" AllowClear="true"
                                    Style="width: 100%;" />
                </RadzenColumn>
                <RadzenColumn Size="6" SizeMD="3">
                    <RadzenLabel Text="Time Period" Style="font-weight: 600; margin-bottom: 0.5rem;" />
                    <RadzenDropDown @bind-Value="@selectedDateFilter" @bind-Value:after="FilterBookings"
                                    Data="@dateOptions" TextProperty="Text" ValueProperty="Value"
                                    Placeholder="All Time" AllowClear="true"
                                    Style="width: 100%;" />
                </RadzenColumn>
            </RadzenRow>
        </RadzenCard>
    </div>

    <!-- Stats Cards -->
    <div class="stats-section" style="margin-bottom: 2rem;">
        <RadzenRow Gap="1.5rem">
            <RadzenColumn Size="6" SizeMD="3">
                <RadzenCard Style="padding: 1.5rem; text-align: center; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
                    <RadzenIcon Icon="event" Style="font-size: 2rem; color: #2563eb; margin-bottom: 0.5rem;" />
                    <RadzenText TextStyle="TextStyle.H4" Text="@totalBookings.ToString()" Style="margin: 0; color: #1f2937;" />
                    <RadzenText TextStyle="TextStyle.Caption" Text="Total Bookings" Style="color: #6b7280;" />
                </RadzenCard>
            </RadzenColumn>
            <RadzenColumn Size="6" SizeMD="3">
                <RadzenCard Style="padding: 1.5rem; text-align: center; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);">
                    <RadzenIcon Icon="play_circle" Style="font-size: 2rem; color: #059669; margin-bottom: 0.5rem;" />
                    <RadzenText TextStyle="TextStyle.H4" Text="@activeBookings.ToString()" Style="margin: 0; color: #1f2937;" />
                    <RadzenText TextStyle="TextStyle.Caption" Text="Active Now" Style="color: #6b7280;" />
                </RadzenCard>
            </RadzenColumn>
            <RadzenColumn Size="6" SizeMD="3">
                <RadzenCard Style="padding: 1.5rem; text-align: center; background: linear-gradient(135deg, #e9d5ff 0%, #ddd6fe 100%);">
                    <RadzenIcon Icon="schedule" Style="font-size: 2rem; color: #7c3aed; margin-bottom: 0.5rem;" />
                    <RadzenText TextStyle="TextStyle.H4" Text="@upcomingBookings.ToString()" Style="margin: 0; color: #1f2937;" />
                    <RadzenText TextStyle="TextStyle.Caption" Text="Upcoming" Style="color: #6b7280;" />
                </RadzenCard>
            </RadzenColumn>
            <RadzenColumn Size="6" SizeMD="3">
                <RadzenCard Style="padding: 1.5rem; text-align: center; background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);">
                    <RadzenIcon Icon="meeting_room" Style="font-size: 2rem; color: #ea580c; margin-bottom: 0.5rem;" />
                    <RadzenText TextStyle="TextStyle.H4" Text="@roomsInUse.ToString()" Style="margin: 0; color: #1f2937;" />
                    <RadzenText TextStyle="TextStyle.Caption" Text="Rooms In Use" Style="color: #6b7280;" />
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>
    </div>

    <!-- Loading State -->
    @if (loading)
    {
        <RadzenRow Gap="1.5rem">
            @for (int i = 0; i < 6; i++)
            {
                <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                    <RadzenCard Style="padding: 1.5rem;">
                        <RadzenText TextStyle="TextStyle.H6" Text="Loading..." />
                        <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" Style="margin-top: 1rem;" />
                    </RadzenCard>
                </RadzenColumn>
            }
        </RadzenRow>
    }
    else if (!filteredBookings.Any())
    {
        <!-- Empty State -->
        <RadzenCard Style="padding: 4rem 2rem; text-align: center;">
            <RadzenIcon Icon="event_busy" Style="font-size: 4rem; color: #9ca3af; margin-bottom: 1rem;" />
            <RadzenText TextStyle="TextStyle.H5" Text="No bookings found" Style="color: #1f2937; margin-bottom: 0.5rem;" />
            <RadzenText TextStyle="TextStyle.Body1" Text="@(string.IsNullOrEmpty(searchTerm) ? "Create your first booking to get started." : "Try adjusting your search or filters.")"
                        Style="color: #6b7280; margin-bottom: 1.5rem;" />
            <RadzenButton Click="@OpenCreateModal" Icon="add" Text="Create Booking"
                          ButtonStyle="ButtonStyle.Primary" />
        </RadzenCard>
    }
    else
    {
        <!-- Bookings Grid -->
        <RadzenRow Gap="1.5rem">
            @foreach (var booking in filteredBookings.OrderByDescending(b => b.StartTime))
            {
                <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                    <RadzenCard Style="@($"padding: 1.5rem; height: 100%; display: flex; flex-direction: column; border-left: 4px solid {GetStatusColor(booking)};")">
                        <!-- Booking Header -->
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <div>
                                <RadzenText TextStyle="TextStyle.H6" Text="@(booking.RoomName ?? "Unknown Room")" Style="margin: 0 0 0.25rem 0; color: #1f2937;" />
                                <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(booking)" Text="@GetBookingStatusText(booking)" />
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <RadzenButton Click="@(() => ViewBookingDetails(booking))" Icon="visibility" ButtonStyle="ButtonStyle.Light"
                                              Variant="Variant.Flat" Size="ButtonSize.Small" />
                                <RadzenButton Click="@(() => EditBooking(booking))" Icon="edit" ButtonStyle="ButtonStyle.Light"
                                              Variant="Variant.Flat" Size="ButtonSize.Small" />
                                <RadzenButton Click="@(() => DeleteBooking(booking))" Icon="delete" ButtonStyle="ButtonStyle.Danger"
                                              Variant="Variant.Flat" Size="ButtonSize.Small" />
                            </div>
                        </div>

                        <!-- Booking Details -->
                        <div style="flex-grow: 1; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <RadzenIcon Icon="schedule" Style="color: #9ca3af;" />
                                <RadzenText TextStyle="TextStyle.Body2" Text="@($"{booking.StartTime:MMM dd, HH:mm} - {booking.EndTime:HH:mm}")" Style="color: #6b7280;" />
                            </div>

                            @if (!string.IsNullOrEmpty(booking.StudentName))
                            {
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <RadzenIcon Icon="school" Style="color: #9ca3af;" />
                                    <RadzenText TextStyle="TextStyle.Body2" Text="@($"Student: {booking.StudentName}")" Style="color: #6b7280;" />
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(booking.ProfessorName))
                            {
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <RadzenIcon Icon="person" Style="color: #9ca3af;" />
                                    <RadzenText TextStyle="TextStyle.Body2" Text="@($"Professor: {booking.ProfessorName}")" Style="color: #6b7280;" />
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(booking.Purpose))
                            {
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <RadzenIcon Icon="description" Style="color: #9ca3af;" />
                                    <RadzenText TextStyle="TextStyle.Body2" Text="@booking.Purpose" Style="color: #6b7280;" />
                                </div>
                            }
                        </div>

                        <!-- Booking Footer -->
                        <div style="border-top: 1px solid #e5e7eb; padding-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <RadzenText TextStyle="TextStyle.Caption" Text="@GetTimeIndicator(booking)" Style="color: #6b7280;" />
                                @if (IsBookingActive(booking))
                                {
                                    <RadzenButton Click="@(() => CheckIn(booking))" Text="Check In" Size="ButtonSize.ExtraSmall"
                                                  ButtonStyle="ButtonStyle.Success" />
                                }
                            </div>
                        </div>
                    </RadzenCard>
                </RadzenColumn>
            }
        </RadzenRow>
    }
</div>