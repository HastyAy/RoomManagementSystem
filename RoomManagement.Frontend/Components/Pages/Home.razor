@page "/"
@page "/dashboard"
@using RoomManagement.Frontend.Services
@using RoomManager.Shared.DTOs
@using Radzen
@using Radzen.Blazor
@inject BookingService BookingService
@inject RoomService RoomService
@inject StudentService StudentService
@inject ProfessorService ProfessorService
@inject NavigationManager Navigation
@inject NotificationService NotificationService

<PageTitle>Dashboard - Room Management System</PageTitle>

<div class="dashboard-container">
    <!-- Header -->
    <div class="header-card">
        <RadzenCard Style="padding: 2rem; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); color: white; border: none;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <RadzenIcon Icon="dashboard" Style="font-size: 3rem; color: white;" />
                <div>
                    <RadzenText TextStyle="TextStyle.H3" Text="Room Management Dashboard"
                                Style="color: white; margin: 0; font-weight: 900;" />
                    <RadzenText TextStyle="TextStyle.Body1" Text="@GetWelcomeMessage()"
                                Style="color: rgba(255,255,255,0.8); margin: 0.25rem 0 0 0;" />
                </div>
                <div style="margin-left: auto;">
                    <RadzenButton Click="@RefreshData" Icon="refresh" ButtonStyle="ButtonStyle.Light"
                                  Variant="Variant.Outlined" IsBusy="@loading" Text="Refresh" />
                </div>
            </div>
        </RadzenCard>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" style="margin-bottom: 2rem;">
        <RadzenRow Gap="1.5rem">
            <!-- Total Rooms Card -->
            <RadzenColumn Size="6" SizeMD="3">
                <RadzenCard Style="@GetStatCardStyle("blue")" @onclick="NavigateToRooms">
                    <div style="cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <RadzenIcon Icon="meeting_room" Style="font-size: 2rem; color: white;" />
                            @if (!loading && totalRooms > lastMonthRooms)
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@($"+{totalRooms - lastMonthRooms}")" />
                            }
                        </div>
                        <RadzenText TextStyle="TextStyle.Caption" Text="Total Rooms"
                                    Style="color: rgba(255,255,255,0.8); margin: 0;" />
                        <RadzenText TextStyle="TextStyle.H4" Text="@(loading ? "..." : totalRooms.ToString())"
                                    Style="color: white; margin: 0; font-weight: 900;" />
                        <RadzenText TextStyle="TextStyle.Caption" Text="@($"Capacity: {totalCapacity}")"
                                    Style="color: rgba(255,255,255,0.6); margin: 0;" />
                    </div>
                </RadzenCard>
            </RadzenColumn>

            <!-- Active Bookings Card -->
            <RadzenColumn Size="6" SizeMD="3">
                <RadzenCard Style="@GetStatCardStyle("green")" @onclick="NavigateToBookings">
                    <div style="cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <RadzenIcon Icon="play_circle" Style="font-size: 2rem; color: white;" />
                            <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="Live" />
                        </div>
                        <RadzenText TextStyle="TextStyle.Caption" Text="Active Bookings"
                                    Style="color: rgba(255,255,255,0.8); margin: 0;" />
                        <RadzenText TextStyle="TextStyle.H4" Text="@(loading ? "..." : activeBookings.ToString())"
                                    Style="color: white; margin: 0; font-weight: 900;" />
                        <RadzenText TextStyle="TextStyle.Caption" Text="Currently in session"
                                    Style="color: rgba(255,255,255,0.6); margin: 0;" />
                    </div>
                </RadzenCard>
            </RadzenColumn>

            <!-- Available Rooms Card -->
            <RadzenColumn Size="6" SizeMD="3">
                <RadzenCard Style="@GetStatCardStyle("purple")" @onclick="NavigateToRooms">
                    <div style="cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <RadzenIcon Icon="check_circle" Style="font-size: 2rem; color: white;" />
                            <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@($"{availabilityRate}%")" />
                        </div>
                        <RadzenText TextStyle="TextStyle.Caption" Text="Available Rooms"
                                    Style="color: rgba(255,255,255,0.8); margin: 0;" />
                        <RadzenText TextStyle="TextStyle.H4" Text="@(loading ? "..." : availableRooms.ToString())"
                                    Style="color: white; margin: 0; font-weight: 900;" />
                        <RadzenText TextStyle="TextStyle.Caption" Text="Ready to book"
                                    Style="color: rgba(255,255,255,0.6); margin: 0;" />
                    </div>
                </RadzenCard>
            </RadzenColumn>

            <!-- People Card -->
            <RadzenColumn Size="6" SizeMD="3">
                <RadzenCard Style="@GetStatCardStyle("orange")" @onclick="NavigateToPeople">
                    <div style="cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <RadzenIcon Icon="group" Style="font-size: 2rem; color: white;" />
                            <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@($"S:{totalStudents} P:{totalProfessors}")" />
                        </div>
                        <RadzenText TextStyle="TextStyle.Caption" Text="Total People"
                                    Style="color: rgba(255,255,255,0.8); margin: 0;" />
                        <RadzenText TextStyle="TextStyle.H4" Text="@(loading ? "..." : (totalStudents + totalProfessors).ToString())"
                                    Style="color: white; margin: 0; font-weight: 900;" />
                        <RadzenText TextStyle="TextStyle.Caption" Text="Students & Professors"
                                    Style="color: rgba(255,255,255,0.6); margin: 0;" />
                    </div>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>
    </div>

    <!-- Main Content Grid -->
    <RadzenRow Gap="2rem" style="margin-bottom: 2rem;">
        <!-- Utilization Overview -->
        <RadzenColumn Size="12" SizeMD="8">
            <RadzenCard Style="padding: 2rem; height: 400px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <RadzenText TextStyle="TextStyle.H5" Text="Room Utilization Overview" Style="margin: 0;" />
                    <RadzenSelectBar @bind-Value="@selectedPeriod"
                                     Data="@periodOptions"
                                     TextProperty="Text"
                                     ValueProperty="Value"
                                     Size="ButtonSize.Small" />
                </div>

                <!-- Utilization Progress -->
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <RadzenText TextStyle="TextStyle.Subtitle1" Text="Current Utilization" Style="margin: 0;" />
                        <RadzenText TextStyle="TextStyle.H6" Text="@($"{utilizationRate}%")"
                                    Style="margin: 0; color: #3b82f6; font-weight: 900;" />
                    </div>
                    <RadzenProgressBar Value="@utilizationRate" Style="height: 12px;" />
                </div>

                <!-- Room Status Grid -->
                @if (loading)
                {
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        @for (int i = 0; i < 4; i++)
                        {
                            <RadzenCard Style="padding: 1rem; min-height: 80px;">
                                <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" Style="margin-bottom: 0.5rem;" />
                                <RadzenText TextStyle="TextStyle.Caption" Text="Loading..." />
                            </RadzenCard>
                        }
                    </div>
                }
                else
                {
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        @foreach (var room in recentRooms)
                        {
                            <RadzenCard Style="@GetRoomCardStyle(room.Status)" @onclick="@(() => ViewRoomDetails(room))">
                                <div style="cursor: pointer;">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Text="@room.Name"
                                                Style="margin: 0 0 0.5rem 0; font-weight: 600;" />
                                    <RadzenBadge BadgeStyle="@GetRoomStatusBadge(room.Status)" Text="@room.Status" />
                                    @if (!string.IsNullOrEmpty(room.CurrentUser))
                                    {
                                        <RadzenText TextStyle="TextStyle.Caption" Text="@($"Used by: {room.CurrentUser}")"
                                                    Style="margin: 0.25rem 0 0 0; color: #6b7280;" />
                                    }
                                </div>
                            </RadzenCard>
                        }
                    </div>
                }
            </RadzenCard>
        </RadzenColumn>

        <!-- Recent Activity -->
        <RadzenColumn Size="12" SizeMD="4">
            <RadzenCard Style="padding: 2rem; height: 400px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <RadzenText TextStyle="TextStyle.H5" Text="Recent Activity" Style="margin: 0;" />
                    <RadzenButton Icon="visibility" Text="View All" Size="ButtonSize.Small"
                                  ButtonStyle="ButtonStyle.Light" Click="@NavigateToBookings" />
                </div>

                @if (loading)
                {
                    <RadzenStack Gap="1rem">
                        @for (int i = 0; i < 3; i++)
                        {
                            <div style="display: flex; gap: 1rem; padding: 1rem; background: #f9fafb; border-radius: 0.75rem;">
                                <div style="width: 40px; height: 40px; background: #e5e7eb; border-radius: 50%;"></div>
                                <div style="flex: 1;">
                                    <div style="height: 1rem; background: #e5e7eb; border-radius: 0.25rem; margin-bottom: 0.5rem;"></div>
                                    <div style="height: 0.75rem; background: #e5e7eb; border-radius: 0.25rem; width: 60%;"></div>
                                </div>
                            </div>
                        }
                    </RadzenStack>
                }
                else
                {
                    <RadzenStack Gap="1rem" Style="max-height: 300px; overflow-y: auto;">
                        @foreach (var activity in recentActivities.Take(5))
                        {
                            <div style="display: flex; gap: 1rem; padding: 1rem; background: #f8fafc; border-radius: 0.75rem; border: 1px solid #e2e8f0;">
                                <div style="@GetActivityIconStyle(activity.Type)">
                                    <RadzenIcon Icon="@GetActivityIcon(activity.Type)" Style="color: white;" />
                                </div>
                                <div style="flex: 1;">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Text="@activity.Room"
                                                Style="margin: 0 0 0.25rem 0; font-weight: 600;" />
                                    <RadzenText TextStyle="TextStyle.Caption" Text="@activity.User"
                                                Style="margin: 0 0 0.25rem 0; color: #6b7280;" />
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <RadzenBadge BadgeStyle="@GetActivityStatusBadge(activity.Status)" Text="@activity.Status" />
                                        <RadzenText TextStyle="TextStyle.Caption" Text="@activity.Time"
                                                    Style="margin: 0; color: #9ca3af;" />
                                    </div>
                                </div>
                            </div>
                        }

                        @if (!recentActivities.Any())
                        {
                            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                                <RadzenIcon Icon="event_busy" Style="font-size: 3rem; color: #d1d5db; margin-bottom: 1rem;" />
                                <RadzenText TextStyle="TextStyle.Body2" Text="No recent activity" Style="margin: 0;" />
                            </div>
                        }
                    </RadzenStack>
                }
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <!-- Quick Actions -->
    <RadzenCard Style="padding: 2rem;">
        <RadzenText TextStyle="TextStyle.H5" Text="Quick Actions" Style="margin: 0 0 1.5rem 0;" />
        <RadzenRow Gap="1.5rem">
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenButton Click="@NavigateToNewBooking" Style="@GetActionCardStyle("blue")" Size="ButtonSize.Large">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div style="text-align: left;">
                            <div style="font-weight: 900; margin-bottom: 0.25rem;">Book a Room</div>
                            <div style="opacity: 0.8; font-size: 0.875rem;">Reserve a space quickly</div>
                        </div>
                        <RadzenIcon Icon="add_circle" Style="font-size: 2rem;" />
                    </div>
                </RadzenButton>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="4">
                <RadzenButton Click="@NavigateToRooms" Style="@GetActionCardStyle("green")" Size="ButtonSize.Large">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div style="text-align: left;">
                            <div style="font-weight: 900; margin-bottom: 0.25rem;">Manage Rooms</div>
                            <div style="opacity: 0.8; font-size: 0.875rem;">Edit room details & settings</div>
                        </div>
                        <RadzenIcon Icon="settings" Style="font-size: 2rem;" />
                    </div>
                </RadzenButton>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="4">
                <RadzenButton Click="@NavigateToPeople" Style="@GetActionCardStyle("purple")" Size="ButtonSize.Large">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div style="text-align: left;">
                            <div style="font-weight: 900; margin-bottom: 0.25rem;">Manage People</div>
                            <div style="opacity: 0.8; font-size: 0.875rem;">Students & Professors</div>
                        </div>
                        <RadzenIcon Icon="people" Style="font-size: 2rem;" />
                    </div>
                </RadzenButton>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>
</div>